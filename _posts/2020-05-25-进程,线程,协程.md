---
layout:     post
title:      进程,线程,协程
subtitle:   进程,线程,协程之间的区别与联系
date:       2020-05-06
author:     LG
header-img: img/post-bg-kuaidi.jpg
catalog: true
tags:
    - 并发
    - java
    - 操作系统
   
---



## 进程,线程,协程


### 1. 进程 

进程是系统资源分配，调度和管理的最小单位。

比如说去任务管理器去查看的时候，我们是看哪一个进程或者是哪一个程序使用了多少内存，而不是哪一个线程。因为如果是线程的话，你根本不知道是哪一个程序的，这样是无法管理的。

### 2. 线程

#### 什么是线程

线程是cpu运算的最小执行单位。

cpu真正执行任务的时候，看到的是线程。cpu 根本不管哪一个进程,cpu就是轮换着线程来执行的。

#### 线程的5种状态

![](https://tva1.sinaimg.cn/large/008eGmZEgy1gnslwyncmuj30ri08o0uc.jpg)

-  New:初始化
-  Runnable:可运行
-  Running:运行中
-  Dead:销毁
-  Blocked:阻塞

注意，阻塞状态下是不占用cpu资源的。而且只有运行中是占用cpu资源的。


#### 线程的创建,销毁,切换会带来资源的损耗

因为线程的本质是我们向CPU申请CPU的计算资源，程序申请外部的计算资源，是需要程序进入到内核态，由操作系统的内核来申请硬件资源。程序在用户态的时候，这些资源是无法直接申请的。所以线程的创建，销毁，切换都必须在内核态进行。

#### 优化线程的创建,销毁所带来的资源损耗

其实比较简单。可以使用线程池。比如说可以在线程池中创建100个线程，在初始化的时候就创建好，以后就不再创建了，就节省了创建线程这一部分的损耗。至于销毁呢，只要线程池还在，就不进行销毁，线程执行结束后呢，就归还到线程池中，但是不对这个线程进行销毁。而是等待下一个任务，由这个线程接收这个任务，进行执行。

#### 优化协程的切换带来的资源损耗

其实线程的切换，是无法避免的带来资源的损耗的。因为系统给程序提供的去获取CPU资源的形式就是线程。多线程情况下，不得不面临的一个问题是，线程之间是切换的，所以对于切换来说，没有特别好的方式来解决资源损耗问题。不过，如果用协程来解决切换问题，还是比较有效的。


### 3. 协程

#### 协程的基本概念

协程是用户自定义的线程，它和线程有很多相同的地方。它不属于操作系统层面的东西。

协程是用户自定义的一套线程，其实和操作系统的运行方式差不多。但是操作系统的线程需要进入内核态来申请cpu的资源。但是协程不需要进入到内核态，因为协程是用户自定义的线程，不需要进入到内核态。

#### 协程的运行原理

![](https://tva1.sinaimg.cn/large/008eGmZEgy1gnslx189gtj311a0gy0y1.jpg)

比如说有一个双核的cpu,然后我们有5个任务，我们创建5个线程去执行。对应cpu的执行，可能有图示的执行顺序，比如 1,2,3,1,3,1。比如，1和2 这俩个线程就存在线程之间的切换带来的开销。可以看到图示的俩个核心都需要切换很多次。

再来看协程的策略。看一下协程的大概思路。

比较理想的状态是: 比如说刚开始创建了俩个线程，线程号是1 和 2。并且开始执行的时候，cpu核心1一直是线程1在执行，cpu核心2一直是线程2在执行。线程数不再增多了，就是2个。现在有5个任务，a,b,c,d,e。创建一套api, 协程去利用线程资源，然后线程再去利用cpu资源，在线程1上运行的协程任务可能是 a,b,a,c,d,e,a。在线程2上运行的协程可能是 c,d,c,e,a,b,a。这里也会存在协程之间的切换，但是这个切换是在用户态的，不需要开销。